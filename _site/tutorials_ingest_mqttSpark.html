<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="A tutorial showing you how to put messages on an MQTT queue, how to consume those messages using Spark Streaming, and how to save those messages to Splice Ma...">
<meta name="keywords" content=" VTI, MQTT, streaming">
<title>MQTT Spark Streaming with Splice Machine | Splice Machine Documentation</title>
<meta class="swiftype" name="title" data-type="string" content="MQTT Spark Streaming with Splice Machine">
<meta class="swiftype" name="info" data-type="string" content="A tutorial showing you how to put messages on an MQTT queue, how to consume those messages using Spark Streaming, and how to save those messages to Splice Machine using a VTI.">
<meta class="swiftype" name="buildversion" data-type="enum" content="2.7.0">

<link rel="stylesheet" href="css/syntax.css">


<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<!--<link rel="stylesheet" href="css/lavish-bootstrap.css"> -->
<!--<link rel="stylesheet" href="css/customstyles.css"> -->
<link rel="stylesheet" href="css/splicemain.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="" href="http://localhost:4000/feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container-fluid topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> Splice Machine Internal Docs</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>
                <!-- entries without drop-downs appear here -->
                
                    
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                   
                      <li class="dropdown">
                          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Splice Machine<b class="caret"></b></a>
                          <ul class="dropdown-menu">
                             
                                
                                   <li><a href="index.html">Welcome</a></li>
                               
                             
                                
                                   <li><a href="tutorials_intro.html">Tutorials</a></li>
                               
                             
                                
                                   <li><a href="sqlref_intro.html">SQL Reference Manual</a></li>
                               
                             
                                
                                   <li><a href="developers_intro.html">Developer's Manual</a></li>
                               
                             
                                
                                   <li><a href="cmdlineref_intro.html">Command Line Reference</a></li>
                               
                             
                                
                                   <li><a href="dbconsole_intro.html">Database Console</a></li>
                               
                             
                                
                                   <li><a href="notes_intro.html">General Information</a></li>
                               
                             
                          </ul>
                      </li>
                   
                      <li class="dropdown">
                          <a href="#" class="dropdown-toggle" data-toggle="dropdown">DB-Service Only<b class="caret"></b></a>
                          <ul class="dropdown-menu">
                             
                                
                                   <li><a href="dbaas_intro.html">Welcome!</a></li>
                               
                             
                                
                                   <li><a href="dbaas_cm_intro.html">Cloud Manager Guide</a></li>
                               
                             
                                
                                   <li><a href="dbaas_zep_intro.html">Using Zeppelin</a></li>
                               
                             
                                
                                   <li><a href="dbaas_info_troubleshoot.html">Troubleshooting/Best Practices</a></li>
                               
                             
                                
                                   <li><a href="dbaas_info_intro.html">Release Information</a></li>
                               
                             
                          </ul>
                      </li>
                   
                      <li class="dropdown">
                          <a href="#" class="dropdown-toggle" data-toggle="dropdown">On-Premise-DB Only<b class="caret"></b></a>
                          <ul class="dropdown-menu">
                             
                                
                                   <li><a href="onprem_intro.html">Welcome!</a></li>
                               
                             
                                
                                   <li><a href="onprem_install_intro.html">Installation</a></li>
                               
                             
                                
                                   <li><a href="onprem_admin_intro.html">Administrator's Guide</a></li>
                               
                             
                                
                                   <li><a href="onprem_info_troubleshoot.html">Troubleshooting/Best Practices</a></li>
                               
                             
                                
                                   <li><a href="onprem_info_intro.html">Release Information</a></li>
                               
                             
                          </ul>
                      </li>
                   
                
                <li>
<!-- Start Swiftype search -->
                    <div id="swiftype-search-container">
                        <form>
                          <input type="text" class="st-default-search-input swiftype-input">
                          <button type="submit" class="swiftype-submit">Search</button>
                        </form>
                    </div>
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container-fluid">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                

<ul id="mysidebar" class="nav">
    <li class="sidebarTitle">Splice Machine Internal v2.7.0</li>
    
    
    
    <li>
        <a href="#">Splice Machine Tutorials</a>
        <ul>
            
            
            
            <li><a href="tutorials_intro.html">Introduction</a></li>
            
            
            
            
        </ul>
     </li>
       
        
    
    <li>
        <a href="#">splice> Command Line</a>
        <ul>
            
            
            
            <li><a href="tutorials_cli_usingcli.html">Getting Started With splice></a></li>
            
            
            
            
            
            
            <li><a href="tutorials_cli_scripting.html">Scripting splice></a></li>
            
            
            
            
            
            
            <li><a href="tutorials_cli_rlwrap.html">RlWrap Summary</a></li>
            
            
            
            
        </ul>
     </li>
       
        
    
    <li>
        <a href="#">Ingestion and Streaming</a>
        <ul>
            
            
            
            <li><a href="tutorials_ingest_uploadtos3.html">Uploading Data to S3</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_ingest_configures3.html">Setting up S3 Access</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_ingest_tpch1.html">Importing TPCH Data</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_ingest_importing.html">Importing Your Data</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_ingest_hfiles.html">Importing Your Data as HFiles</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_ingest_kafkaproducer.html">Creating a Kafka Producer</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_ingest_kafkafeed.html">Configuring a Kafka Feed</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_ingest_storm.html">Using Apache Storm</a></li>
            
            
            
            
            
            
            <li class="active"><a href="tutorials_ingest_mqttSpark.html">MQTT&#160;Spark Streaming</a></li>
            
            
            
            
        </ul>
     </li>
       
        
    
    <li>
        <a href="#">Analytics and Machine Learning</a>
        <ul>
            
            
            
            <li><a href="tutorials_ml_zeppelin.html">Using Zeppelin</a></li>
            
            
            
            
        </ul>
     </li>
       
        
    
    <li>
        <a href="#">Connecting Programmatically</a>
        <ul>
            
            
            
            <li><a href="tutorials_connect_haproxy.html">Connecting through HAProxy</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_connect_java.html">Connecting with Java</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_connect_jruby.html">Connecting with JRuby</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_connect_jython.html">Connecting with Jython</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_connect_scala.html">Connecting with Scala</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_connect_angular.html">Connecting with NodeJS</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_connect_odbcinstall.html">Installing our ODBC&#160;Driver</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_connect_python.html">Connecting with Python</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_connect_odbcc.html">Connecting with C&#160;and ODBC</a></li>
            
            
            
            
        </ul>
     </li>
       
        
    
    <li>
        <a href="#">Connecting BI Tools</a>
        <ul>
            
            
            
            <li><a href="tutorials_connect_dbeaver.html">Connecting DBeaver</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_connect_dbvisualizer.html">Connecting DBVisualizer</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_connect_cognos.html">Connecting Cognos</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_connect_squirrel.html">Connecting SQuirreL</a></li>
            
            
            
            
            
            
            <li><a href="tutorials_connect_tableau.html">Connecting Tableau</a></li>
            
            
            
            
        </ul>
     </li>
       
        
        
        <!-- if you aren't using the accordion, uncomment this block:
           <p class="external">
               <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
           </p>
           -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            

<div class="post-content">

<!--- Don't automatically put page summary at top - GRH 05/2017:
   
    <div class="summary">A tutorial showing you how to put messages on an MQTT queue, how to consume those messages using Spark Streaming, and how to save those messages to Splice Machine using a VTI.</div>
   
-->

    


    

  <section>
<div class="TopicContent" data-swiftype-index="true">
    <h1 id="streaming-mqttspark-data">Streaming MQTT Spark Data</h1>

    <p>This topic walks you through using MQTT Spark streaming with
Splice Machine. MQTT is a lightweight, publish-subscribe messaging
protocol designed for connecting remotely when a small footprint is
required. MQTT is frequently used for data collection with the Internet
of Things (IoT).</p>

    <p>The example code in this tutorial uses <a href="https://mosquitto.org/" target="_blank">Mosquitto</a>, which is an open source message broker that implements
the MQTT. This tutorial uses a cluster managed by MapR; if you’re using
different platform management software, you’ll need to make a few
adjustments in how the code is deployed on your cluster.</p>

    <p class="noteNote">All of the code used in this tutorial is available in our <a href="https://github.com/splicemachine/splice-community-sample-code" target="_blank">GitHub
community repository</a>.</p>

    <div>
      <p>You can complete this tutorial by <a href="#Watch">watching a short video</a> or by
<a href="#Written">following the written directions</a> below.</p>

      <h2 id="Watch">Watch the Video</h2>

      <p>The following video shows you how to:</p>

      <ul>
        <li>put messages on an MQTT queue</li>
        <li>consume those messages using Spark streaming</li>
        <li>save those messages to Splice Machine with a virtual table (VTI)</li>
      </ul>

      <div class="centered">
        <iframe class="youtube-player_0" src="https://www.youtube.com/embed/Nt2J2khM0Xw?" frameborder="0" allowfullscreen="1" width="560px" height="315px"></iframe>

      </div>
    </div>

    <h2 id="Written">Written Walk Through</h2>

    <p>This section walks you through the same sequence of steps as the video,
in these sections:</p>

    <ul>
      <li><a href="#Deployin">Deploying the Tutorial Code</a> walks you through downloading
and deploying the sample code.</li>
      <li><a href="#About">About the Sample Code</a> describes the high-level methods in
each class.</li>
      <li><a href="#About2">About the Sample Code Scripts</a> describes the scripts used to
deploy and execute the sample code.</li>
    </ul>

    <h3 id="Deployin">Deploying the Tutorial Code</h3>

    <p>Follow these steps to deploy the tutorial code:</p>

    <div class="opsStepsList">
      <ol class="boldFont">
        <li>
          <p class="topLevel">Download the code from our <a href="https://github.com/splicemachine/splice-community-sample-code/tree/master/tutorial-mqtt-spark-streaming" target="_blank">GitHub community repository.</a></p>

          <p class="indentLevel1">Pull the code from our git repository:</p>

          <div class="preWrapperWide">
            <pre class="Plain"><code>https://github.com/splicemachine/splice-community-sample-code/tree/master/tutorial-mqtt-spark-streaming
</code></pre>

          </div>
        </li>
        <li>
          <p class="topLevel">Compile and package the code:</p>

          <div class="preWrapperWide">
            <pre class="ShellCommand"><code>mvn clean compile package
</code></pre>

          </div>
        </li>
        <li>
          <p class="topLevel">Copy three JAR files to each server:</p>

          <p class="indentLevel1">Copy these three files:</p>

          <div class="preWrapperWide">
            <pre class="Plain"><code>./target/splice-tutorial-mqtt-2.0.jarspark-streaming-mqtt_2.10-1.6.1.jarorg.eclipse.paho.client.mqttv3-1.1.0.jar
</code></pre>

          </div>

          <p class="indentLevel1">to this directory on each server:</p>

          <div class="preWrapperWide">
            <pre class="Plain"><code> /opt/splice/default/lib
</code></pre>

          </div>
        </li>
        <li>
          <p class="topLevel">Restart Hbase</p>
        </li>
        <li>
          <p class="topLevel">Create the target table in splice machine:</p>

          <p class="indentLevel1">Run this script to create the table:</p>

          <div class="preWrapperWide">
            <pre class="Plain"><code> create-tables.sql
</code></pre>

          </div>
        </li>
        <li>
          <p class="topLevel">Start Mosquitto:</p>

          <div class="preWrapperWide">
            <pre class="ShellCommand"><code>sudo su /usr/sbin/mosquitto -d -c /etc/mosquitto/mosquitto.conf &gt; /var/log/mosquitto.log 2&gt;&amp;1
</code></pre>

          </div>
        </li>
        <li>
          <p class="topLevel">Start the Spark streaming script:</p>

          <div class="preWrapperWide">
            <pre class="ShellCommand"><code>sudo -su mapr ./run-mqtt-spark-streaming.sh tcp://srv61:1883 /testing 10
</code></pre>

          </div>

          <p class="indentLevel1">The first parameter (<code>tcp://srv61:1883</code>) is the MQTT broker, the
second (<code>/testing</code>) is the topic name, and the third (<code>10</code>) is the
number of seconds each stream should run.</p>
        </li>
        <li>
          <p class="topLevel">Start putting messages on the queue:</p>

          <p class="indentLevel1">Here’s a java program that is set up to put messages on the queue:</p>

          <div class="preWrapperWide">
            <pre class="ShellCommand"><code>java -cp /opt/splice/default/lib/splice-tutorial-mqtt-2.0-SNAPSHOT.jar:/opt/splice/default/lib/org.eclipse.paho.client.mqttv3-1.1.0.jar com.splicemachine.tutorials.sparkstreaming.mqtt.MQTTPublisher tcp://localhost:1883 /testing 1000 R1
</code></pre>

          </div>

          <p class="indentLevel1">The first parameter (<code>tcp://localhost:1883</code>) is the MQTT broker, the
second (<code>/testing</code>) is the topic name, the third (<code>1000</code>) is the
number of iterations to execute, and the fourth parameter (<code>R1</code>) is
a prefix for this run.</p>

          <p class="noteNote">The source code for this utility program is in a different GitHub
project than the rest of this code. You’ll find it in the
    <a href="https://github.com/splicemachine/splice-community-sample-code/tree/master/tutorial-kafka-producer" target="_blank"><code>tutorial-kafka-producer</code></a> Github project.</p>
        </li>
      </ol>

    </div>
    <h3 id="About">About the Sample Code</h3>

    <p>This section describes the main class methods used in this MQTT example
code; here’s a summary of the classes:</p>

    <table>
    <col />
    <col />
    <thead>
        <tr>
            <th>Java Class</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td class="CodeFont"><a href="#MQTTPubl">MQTTPublisher</a>
            </td>
            <td>Puts csv messages on an MQTT queue.</td>
        </tr>
        <tr>
            <td class="CodeFont"><a href="#SparkStr">SparkStreamingMQTT</a>
            </td>
            <td>The Spark streaming job that reads messages from the MQTT queue.</td>
        </tr>
        <tr>
            <td class="CodeFont"><a href="#SaveRDD">SaveRDD</a>
            </td>
            <td>Inserts the data into Splice Machine using the <code>RFIDMessageVTI</code> class.</td>
        </tr>
        <tr>
            <td class="CodeFont"><a href="#RFIDMess2">RFIDMessageVTI</a>
            </td>
            <td>A virtual table interface for parsing an <code>RFIDMessage</code>.</td>
        </tr>
        <tr>
            <td class="CodeFont"><a href="#RFIDMess">RFIDMessage</a>
            </td>
            <td>Java object (a POJO) for converting from a csv string to an object to a database entry.</td>
        </tr>
    </tbody>
</table>
    <h4 id="MQTTPubl">MQTTPublisher</h4>

    <p>This class puts CSV messages on an MQTT queue. The function of most
interest in MQTTPublisher.java is <code>DoDemo</code>, which controls our sample
program:</p>

    <div class="preWrapperWide">
      <pre class="Example"><code>public void doDemo() {
   try {
        long startTime = System.currentTimeMillis();
        client = new MqttClient(broker, clientId);
        client.connect();
        MqttMessage message = new MqttMessage();
        for (int i=0; inumMessages; i++) {
            // Build a csv string
            message.setPayload( prefix + "Asset" + i ", Location" + i + "," + new Timestamp((new Date()).getTime())).getBytes());
            client.publish(topicName, message);
            if (i % 1000 == 0) {
                System.out.println("records:" + i + " duration=" + (System.currentTimeMillis() - startTime));
                startTime = System.currentTimeMillis();
            }
        client.disconnect();
    } catch (MqttException e) {
        e.printStackTrace();
    }
}
</code></pre>

    </div>
    <p><code>DoDemo</code> does a little initialization, then starts putting messages out
on the queue. Our sample program is set up to loop until it creates
<code>numMessages</code> messages; after every 1000 messages, it displays a status
message that helps us determine how much time is going to put messages
on the queue, and how much to take them off the queue.</p>

    <p><code>DoDemo</code> builds a csv record (line) for each message, setting an
asset ID, a location ID, and a timestamp in the <code>payload</code> of the
message. It them publishes that message to the topic <code>topicName</code>.</p>

    <h4 id="SparkStr">SparkStreamingMQTT</h4>

    <p>Once the messages are on the queue, our <code>SparkStreamingMQTT</code> class
object reads them from the queue and inserts them into our database. The
main method in this class is <code>processMQTT</code>:</p>

    <div class="preWrapperWide">
      <pre class="Example"><code>public void processMQTT(final String broker, final String topic, final int numSeconds) {

    LOG.info("************ SparkStreamingMQTTOutside.processMQTT start");

    // Create the spark application and set the name to MQTT
    SparkConf sparkConf = new SparkConf().setAppName("MQTT");

    // Create the spark streaming context with a 'numSeconds' second batch size
    jssc = new JavaStreamingContext(sparkConf, Durations.seconds(numSeconds));
    jssc.checkpoint(checkpointDirectory);

    LOG.info("************ SparkStreamingMQTTOutside.processMQTT about to read the MQTTUtils.createStream");
    //2. MQTTUtils to collect MQTT messages
    JavaReceiverInputDStreamString&gt; messages = MQTTUtils.createStream(jssc, broker, topic);

    LOG.info("************ SparkStreamingMQTTOutside.processMQTT about to do foreachRDD");
    //process the messages on the queue and save them to the database
    messages.foreachRDD(new SaveRDD());

    LOG.info("************ SparkStreamingMQTTOutside.processMQTT prior to context.strt");
    // Start the context
    jssc.start();
    jssc.awaitTermination();
}
</code></pre>

    </div>
    <p class="spaceAbove">The <code>processMQTT</code> method takes three parameters:</p>

    <div class="paramList">
      <p class="paramName">broker</p>

      <p class="paramDefnFirst">The URL of the MQTT broker.</p>

      <p class="paramName">topic</p>

      <p class="paramDefnFirst">The MQTT topic name.</p>

      <p class="paramName">numSeconds</p>

      <p class="paramDefnFirst">The number of seconds at which streaming data will be divided into
batches.</p>

    </div>
    <p class="spaceAbove">The <code>processMQTT</code> method processes the messages on the queue and saves
them by calling the <code>SaveMDD</code> class.</p>

    <h4 id="SaveRDD">SaveRDD</h4>

    <p>The <code>SaveRDD</code> class is an example of a Spark streaming function that
uses our virtual table interface (VTI) to insert data into your Splice
Machine database. This function checks for messages in the stream, and
if there any, it creates a connection your database and uses a prepared
statement to insert the messages into the database.</p>

    <div class="preWrapperWide">
      <pre class="Example"><code>/**
 * This is an example of spark streaming function that
 * inserts data into Splice Machine using a VTI.
 *
 * @author Erin Driggers
 */

public class SaveRDD implements FunctionJavaRDDString&gt;, Void&gt;, Externalizable {

    private static final Logger LOG = Logger.getLogger(SaveRDD.class);

    @Override
    public Void call(JavaRDDString&gt; rddRFIDMessages) throws Exception {
        LOG.debug("About to read results:");
        if (rddRFIDMessages != null '&amp; rddRFIDMessages.count() &gt; 0) {
            LOG.debug("Data to process:");
            //Convert to list
            ListString&gt; rfidMessages = rddRFIDMessages.collect();
            int numRcds = rfidMessages.size();

            if (numRcds &gt; 0) {
                try {
                    Connection con = DriverManager.getConnection("jdbc:splice://localhost:1527/splicedb;user=splice;password=admin");

                    //Syntax for using a class instance in a VTI, this could also be a table function
                    String vtiStatement = "INSERT INTO IOT.RFID "
                            + "select s.* from new com.splicemachine.tutorials.sparkstreaming.mqtt.RFIDMessageVTI(?) s ("
                            + RFIDMessage.getTableDefinition() + ")";
                    PreparedStatement ps = con.prepareStatement(vtiStatement);
                    ps.setObject(1, rfidMessages);
                    ps.execute();
                } catch (Exception e) {
                    //It is important to catch the exceptions as log messages because it is difficult
                    //to trace what is happening otherwise
                    LOG.error("Exception saving MQTT records to the database" + e.getMessage(), e);
                } finally {
                    LOG.info("Complete insert into IOT.RFID");
                }
            }
        }
        return null;
    }
</code></pre>

    </div>
    <p class="spaceAbove">The heart of this function is the statement that creates the prepared
statement, using a VTI class instance:</p>

    <div class="preWrapperWide">
      <pre class="Plain"><code>String vtiStatement = "INSERT INTO IOT.RFID "     + "select s.* from new     com.splicemachine.tutorials.sparkstreaming.mqtt.RFIDMessageVTI(?) s ("
    + RFIDMessage.getTableDefinition() + ")";
PreparedStatement ps = con.prepareStatement(vtiStatement);
</code></pre>

    </div>
    <p>Note that the statement references both our <code>RFIDMessage</code> and
<code>RFIDMessageVTI</code> classes, which are described below.</p>

    <h4 id="RFIDMess2">RFIDMessageVTI</h4>

    <p>The <code>RFIDMessageVTI</code> class implements an example of a virtual table
interface that reads in a list of strings that are in CSV format,
converts that into an <code>RFIDMessage</code> object, and returns the resultant
list in a format that is compatible with Splice Machine.</p>

    <p>This class features an override of the <code>getDataSet</code> method, which loops
through each CSV record from the input stream and converts it into an
<code>RFIDMessage</code> object that is added onto a list of message items:</p>

    <div class="preWrapperWide">
      <pre class="Example"><code>@Override
public DataSetLocatedRow&gt; getDataSet(SpliceOperation op, DataSetProcessor dsp, ExecRow execRow) throws StandardException {
    operationContext = dsp.createOperationContext(op);

    //Create an arraylist to store the key / value pairs
    ArrayListLocatedRow&gt; items = new ArrayListLocatedRow&gt;();

    try {

        int numRcds = this.records == null ? 0 : this.records.size();

        if (numRcds &gt; 0) {

            LOG.info("Records to process:" + numRcds);
            //Loop through each record convert to a SensorObject
            //and then set the values
            for (String csvString : records) {
                CsvBeanReader beanReader = new CsvBeanReader(new StringReader(csvString), CsvPreference.STANDARD_PREFERENCE);
                RFIDMessage msg = beanReader.read(RFIDMessage.class, header, processors);
                items.add(new LocatedRow(msg.getRow()));
            }
        }
    } catch (Exception e) {
        LOG.error("Exception processing RFIDMessageVTI", e);
    } finally {
        operationContext.popScope();
    }
    return new ControlDataSet&gt;(items);
}
</code></pre>

    </div>
    <p class="noteIcon">For more information about using our virtual table interface, see <a href="developers_fundamentals_vti.html">Using
the Splice Machine Virtual Table
Interface.</a></p>

    <h4 id="RFIDMess">RFIDMessage</h4>

    <p>The <code>RFIDMessage</code> class creates a simple Java object (a POJO) that
represents an RFID message; we use this to convert an incoming
CSV-formatted message into an object. This class includes getters and
setters for each of the object properties, plus the <code>getTableDefinition</code>
and <code>getRow</code> methods:</p>

    <div class="preWrapperWide">
      <pre class="Example"><code>/**
 * Used by the VTI to build a Splice Machine compatible resultset
 *
 * @return
 * @throws SQLException
 * @throws StandardException
 */
public ValueRow getRow() throws SQLException, StandardException {
    ValueRow valueRow = new ValueRow(5);
    valueRow.setColumn(1, new SQLVarchar(this.getAssetNumber()));
    valueRow.setColumn(2, new SQLVarchar(this.getAssetDescription()));
    valueRow.setColumn(3, new SQLTimestamp(this.getRecordedTime()));
    valueRow.setColumn(4, new SQLVarchar(this.getAssetType()));
    valueRow.setColumn(5, new SQLVarchar(this.getAssetLocation()));
    return valueRow;
}

/**
 * Table definition to use when using a VTI that is an instance of a class
 *
 * @return
 */
public static String getTableDefinition() {
    return "ASSET_NUMBER varchar(50), "
    + "ASSET_DESCRIPTION varchar(100), "
    + "RECORDED_TIME TIMESTAMP, "
    + "ASSET_TYPE VARCHAR(50), "
    + "ASSET_LOCATION VARCHAR(50) ";
}
</code></pre>

    </div>
    <p>The <code>getTableDefinition</code> method is a string description of the table
into which you’re inserting records; this pretty much replicates the
specification you would use in an SQL <code>CREATE_TABLE</code> statement.</p>

    <p>The <code>getRow</code> method creates a data row with the appropriate number of
columns, uses property getters to set the value of each column, and
returns the row as a <code>resultset</code> that is compatible with Splice Machine.</p>

    <h3 id="About2">About the Sample Code Scripts</h3>

    <p>These are also two scripts that we use with this tutorial:</p>

    <table>
    <col />
    <col />
    <thead>
        <tr>
            <th>Class</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>/ddl/create-tables.sql</code></td>
            <td>A simple SQL script that you can use to have Splice Machine create the table into which RFID messages are stored.</td>
        </tr>
        <tr>
            <td><code>/scripts/run-mqtt-spark-streaming.sh</code></td>
            <td>Starts the Spark streaming job.</td>
        </tr>
    </tbody>
</table>
  </div>
</section>



    <div class="tags">
        
    </div>



</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy;2017 Splice Machine, Inc. All rights reserved. <br />
 Site last generated: Dec 12, 2017 <br />
<p><img src="images/company_logo.png" alt="Company logo"/></p>
                </div>
            </div>
</footer>


        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
    </div>

        <!-- Swiftype script; values depend on which built type and which build version -->

<script type="text/javascript">
(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

_st('install','YGtH3zGt4NJzs35yCo5A','2.0.0', {
  install: {
    hooks: {
      query_filter: function(query) {
        query.setFilterDataByDocumentTypeSlugAndFilterField('page', 'buildversion', { values: ['2.7.0'], type: "and" });

        return query;
      }
    }
  }
});
</script>


</body>
    <!-- Only include analytics scripts if generating the customer docs -->


</html>
