b            ---- ï»¿Building a New Docs Release ----

    (Google docs version here: https://docs.google.com/document/d/1UKIPB7nM7B0q56t108pjnySO1s0eVfHfFF3_pXCkVSA/edit?usp=sharing)

We use a number of steps to build a new release while also maintaining docs for one or more previous releases:

    1. Build the PDF and then the web for the previous version(s).
    2. Upload the built previous version web (which includes the PDF) to a NewVersion subdirectory on splicemachine.com/<prev>, where <prev> is the version number (e.g. 2.5).
    3. Take that version live, using a script on the server.
    4. Build the PDF and then build the web for the current version.
    5. Upload the built current version web to a NewVersion subdirectory on splicemachine.com.
    6. Take that version live, using a server script.
    7. Tell SwifType to re-crawl the web
    8. Make sure all is well.

In the next sections, we outline these steps in detail:
    * Build the Previous Release First
    * Next, Build the Current Release
    * Update Search
When creating a new "previous release" directory, you must first prepare that directory with a few files; this is described here
    * Build the Previous Release First
    * Next, Build the Current Release
    * Update Search

A Note About Serve vs Build:
    We use Jekyll to build the docs system, and we use two scripts:
        * Use `servesplice` to tell Jekyll to serve a docs system. When it serves, Jekyll does the build, then runs the built web locally and serves it on `http://127.0.0.1:4000` (for doc or docstest) or `http://127.0.0.1:4006` (for docsdev). This is how we examine and test our changes during the development cycle. Use `CTRL-C` to terminate the run of a served session.

        * Use `buildsplice` to tell Jekyll to build a production docs system. This differs from `servesplice` only in that our script needs to rename and/or copy some (sitemap) files after the build completes. However, if you serve the web and then Ctrl-C to terminate the run, those steps are not run, because the script has been cancelled.


_________________________________
Build the Previous Release First:
_________________________________

    1. In Git:
       a. Switch to the 2.5 branch of the splicedocs-jekyll repo

    2. Using a text editor such as Atom:
       a. Open the docs project
       b. Update any values that need updating in the _includes/splicevars.html file.

    3. In Terminal:
       a. cd to splicedocs-jekyll directory  (alias=splicedocs)
       b. Use the ./buildsplicepdf script to build the PDF version of 2.5
       c. Use the ./buildsplice script to build the 2.5 version of doc.

    4. In an FTP client:
       a. Connect to doc.splicemachine.com/2.5
       b. Create a directory in there named NewVersion
       c. Transfer the contents of splicedocs-jekyll/_site/ to NewVersion/

    5. In a browser:
       a. Point to https://doc.splicemachine.com/2.5/NewVersion to verify the upload

    6. In Terminal:
       a. ssh into the splicemachine server  (alias=spliceputty)
       b. cd subs/doc/2.5
       c. Use ls -d ./*/ to verify that subdirectory NewVersion exists
       d. Use ./UpdateVersion.sh to backup the current version of 2.5 and take the contents of /NewVersion live.

    7. In a browser:
       a. Point to https://doc.splicemachine.com/2.5 to verify all is well

    8. In Git (if you made any changes to the source):
       a. Commit & push those changes to the repo branch.


NOTE: You must create and structure the previous release dir on the server before using this process. See the final section of this topic for instructions.


_________________________________
Next, Build the Current Release:
_________________________________

    1. In Git:
       a. Switch to the current version (possibly `master`) branch of the splicedocs-jekyll repo

    2. Using a text editor such as Atom:
       a. Open the docs project
       b. Update any values that need updating in the _includes/splicevars.html file.

    3. In Terminal:
       a. cd to splicedocs-jekyll directory  (alias=splicedocs)
       b. Use the ./buildsplicepdf script to build the PDF version of 2.7
       c. Use the ./buildsplice script to build the 2.5 version of doc.

    4. In an FTP client:
       a. Connect to doc.splicemachine.com
       b. Create a directory in there named NewVersion
       c. Transfer the contents of splicedocs-jekyll/_site/ to NewVersion/

    5. In a browser:
       a. Point to https://doc.splicemachine.com/NewVersion to verify the upload

    6. In Terminal:
       a. ssh into the splicemachine server  (alias=spliceputty)
       b. cd subs/doc
       c. Use ls -d ./*/ to verify that subdirectory NewVersion exists
       d. Use ./UpdateVersion.sh to backup the current version and take the contents of /NewVersion live.

    7. In a browser:
       a. Point to https://doc.splicemachine.com to verify all is well

    8. In Git (if you made any changes to the source):
       a. Commit & push those changes to the repo branch.

    NOTE: You may want to create a new branch for the new release.


_________________________________
Update Search
_________________________________

After updating the docs on the server, you must tell Swiftype Site Search to re-index the site:
    1. Point your browser to the Splice Machine Swiftype Dashboard: https://app.swiftype.com/engines/splicedocs/overview

    2. Click the large Domains button in the Dashboard

    3. Click the Manage down-arrow and select ReCrawl

    4. Check back on this page after 4-8 hours. It will show the most recently created crawl time.

    5. Once the crawl has completed, navigate to the site and verify that search is working.


    NOTE: Re-indexing the doc.splicemachine.com site can require 6-12 hours; this time increases as additional previous-release subdirectories need to be indexed. While Swiftype is recrawling the site, search results may be suspects. We usually initiate these recrawls after 6pm.

_________________________________
Preparing a New "Previous Release" Directory
_________________________________

If you need to create a new "previous release" directory on the server, that directory must be pre-populated with several files before you upload the docs there.

For example, if Splice Machine releases version 2.8, and wants to maintain the documentation for customers on 2.5 and 2.7, we would need to create and pre-populate a 2.7 directory.

You can prepare the directory on the server by simply following these steps:

    1. Ssh into doc.splicemachine.com

    2. Issue these shell commands:
       a. mkdir 2.7
       b. shopt -s extglob
       c. cp -r !(2.7) 2.7/
       d. shopt -u extglob

    3. Edit the UpdateVersion.sh script, removing any lines (near the top) that move previous release versions into the Temp directory. For example, you would remove this line:
       mv 2.5 Temp/
    You must also make one change in the UpdateVersion.sh script that's located in the top-level doc.splicemachine.com:

    4. Edit the UpdateVersion.sh script, adding a line to move your new prev-release directory to Temp. For example, you would add a line for 2.7, so the UpdateVersion.sh script now would contain:
       mv 2.5 Temp/
       mv 2.7 Temp/

NOW, Update the servesplice, buildsplice, and buildsplicepdf shell scripts in the repos:
    1. Add the new release versions (e.g. 'docsdev 2.8', 'docstest 2.8', 'doc 2.8') in the case statements in both scripts.
    2. In servesplice and buildsplice script, make sure to change the smap value of the now-previous (e.g. 2.7) version(s), so that they're generating e.g. sitemapgen.2.7

FINALLY: update the sitemapindex.xxx.xml files for the new version
    Add a new sitemap to the set of sitemaps in sitemapindex.docstest.xml, and (when ready to go live) to sitemapindex.doc.xml.  You can also do this in docsdev, but its site index doesn't get used, so it does no good (but does no harm).

    For example, this:
        <sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
          <sitemap>
            <loc>https://docstest.splicemachine.com/2.7/sitemap.2.7.xml</loc>
          </sitemap>
          <sitemap>
            <loc>https://docstest.splicemachine.com/2.5/sitemap.2.5.xml</loc>
          </sitemap>
        </sitemapindex>

    Becomes this:
        <sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
          <sitemap>
            <loc>https://docstest.splicemachine.com/sitemap.2.8.xml</loc>
          </sitemap>
          <sitemap>
            <loc>https://docstest.splicemachine.com/2.7/sitemap.2.7.xml</loc>
          </sitemap>
          <sitemap>
            <loc>https://docstest.splicemachine.com/2.5/sitemap.2.5.xml</loc>
          </sitemap>
        </sitemapindex>



Now you'll be able to FTP updated versions of the 2.7 docs to your new directory and use the UpdateVersion.sh script to take that update live.
