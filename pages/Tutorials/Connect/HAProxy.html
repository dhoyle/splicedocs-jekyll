---
title: Connecting to Splice Machine Through HAProxy
summary: How to connect to Splice Machine through HAProxy
keywords: haproxy, load balancing, high availability, TCP requests, http requests, client requests, kerberos
toc: false
product: all
sidebar: tutorials_sidebar
permalink: tutorials_connect_haproxy.html
folder: Tutorials/Connect
---
	<section>
	<div class="TopicContent" data-swiftype-index="true">
        <h1>Configuring Load Balancing and High Availability with HAProxy</h1>
        <p>HAProxy is an open source utility that is available on most Linux distributions and cloud platforms for load-balancing TCP and HTTP requests. Users can leverage this tool to distribute incoming client requests among the region server nodes on which Splice Machine instances are running.</p>
        <p>The advantages of using HAProxy with Splice Machine clusters are:</p>
        <ul>
            <li>Users need to point to only one JDBC host and port for one Splice Machine cluster, which may have 100s of nodes.</li>
            <li>The HAProxy service should ideally be running on a separate node that is directing the traffic to the region server nodes; this means that if one of the region server node goes down, users can still access the data from another region server node.</li>
            <li>The load balance mechanism in HAProxy helps distribute the workload evenly among the set of nodes; you can optionally select this algorithm in your configuration, which can  help increase throughput rate.</li>
        </ul>
        <p>The remainder of this topic walks you through:</p>
        <ul>
            <li><a href="#Configur">Configuring HAProxy on a non-Splice Machine node that is running Red Hat Enterprise Linux</a>.</li>
            <li><a href="#Using">Using HAProxy on a Kerberos-enabled cluster</a>
            </li>
        </ul>
        <h2 id="Configur">Configuring HAProxy with Splice Machine</h2>
        <p>The following example shows you how to  configure HAProxy load balancer on a non-Splice Machine node on a Red Hat Enterprise Linux  system. Follow these steps:</p>
        <div class="opsStepsList">
            <ol class="boldFont">
                <li>
                    <p class="topLevel">

Install HAProxy as superuser
:</p>
                    <div class="preWrapper"><pre class="ShellCommand"># yum install haproxy
</pre>
                    </div>
                </li>
                <li>
                    <p class="topLevel">Configure the <code>/etc/haproxy/haproxy.cfg</code> file, following the comments in the sample file below:</p>
                    <p>
In this example, we set the incoming requests to <code>haproxy_host:1527</code>, which uses a balancing algorithm of least connections to distribute among the nodes <code>srv127, srv128, srv129, </code>and <code>srv130</code>. This means that the incoming connection is routed to the region server that has the least number of connections; thus, the client JDBC URL should point to <code>&lt;haproxy_host&gt;:1527</code>.
</p>
                    <p class="noteNote">The HAProxy manual describes other balancing algorithms that you can use.</p>
                    <p>Here is the <code>haproxy.cfg</code> file for this example:</p>
                    <div class="preWrapperWide"><pre class="Example">#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    # to have these messages end up in /var/log/haproxy.log you will
    # need to:
    #
    # 1) configure syslog to accept network log events.  This is done
    #    by adding the '-r' option to the SYSLOGD_OPTIONS in
    #    /etc/sysconfig/syslog
    #
    # 2) configure local2 events to go to the /var/log/haproxy.log
    #   file. A line like the following can be added to
    #   /etc/sysconfig/syslog
    #
    #    local2.*                       /var/log/haproxy.log
    #
    maxconn 4000
    log 127.0.0.1 local2
    user haproxy
    group haproxy


#---------------------------------------------------------------------
# common defaults that all the 'listen' and 'backend' sections will
# use if not designated in their block
#---------------------------------------------------------------------
defaults
    log global
    retries 2
    timeout connect 30000
    timeout server 50000
    timeout client 50000

#----------------------------------------------------------------------
# This enables jdbc/odbc applications to connect to HAProxy_host:1527 port
# so that HAProxy can balance between the splice engine cluster nodes
# where each node's splice engine instance is listening on port 1527
#----------------------------------------------------------------------
listen splice-cluster
    bind *:1527
    log global
    mode tcp
    option tcplog
    option tcp-check
    option log-health-checks
    timeout client 3600s
    timeout server 3600s
    balance leastconn
    server srv127 10.1.1.227:1527 check
    server srv128 10.1.1.228:1527 check
    server srv129 10.1.1.229:1527 check
    server srv130 10.1.1.230:1527 check

#--------------------------------------------------------
# (Optional) set up the stats admin page at port 1936
#--------------------------------------------------------
listen   stats :1936
    mode http
    stats enable
    stats hide-version
    stats show-node
    stats auth admin:password
    stats uri  /haproxy?stats
</pre>
                    </div>
                    <p>Note that some of the parameters may need tuning per the sizing and workload nature:</p>
                    <ul class="plainFont">
                        <li>The <code>maxconnections</code> parameter indicates how many concurrent connections are served at any given time; you may need to configure this, based on size of the cluster and expected inbound requests.</li>
                        <li>Similarly, the <code>timeout</code> values, which are by default in msecs, should be tuned so that the connection does not get terminated while a long-running query is executed.</li>
                    </ul>
                </li>
                <li>
                    <p class="topLevel">

Start the HAProxy service:</p>
                    <p>As superuser, follow these steps to enable the HAProxy service:</p>
                    <table>
                        <col />
                        <col />
                        <thead>
                            <tr>
                                <th>Distribution</th>
                                <th>Instructions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="ConsoleLink">Redhat / CentOS EL6</td>
                                <td>
                                    <div class="preWrapperWide"><pre class="ShellCommandCell"># chkconfig haproxy on
# service haproxy start
</pre>
                                    </div>
                                    <p>If you change the configuaration file, reload it with this command:</p>
                                    <div class="preWrapperWide"><pre class="ShellCommandCell"># service haproxy reload</pre>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td class="ConsoleLink">Redhat / CentOS EL7</td>
                                <td>
                                    <div class="preWrapperWide"><pre class="ShellCommandCell"># systemctl enable haproxy<br />ln -s '/usr/lib/systemd/system/haproxy.service<br />'/etc/systemd/system/multi-user.target.wants/haproxy.service'<br /># systemctl start haproxy</pre>
                                    </div>
                                    <p>If you change the configuaration file, reload it with this command:</p>
                                    <div class="preWrapperWide"><pre class="ShellCommandCell"># systemctl haproxy reload</pre>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <p class="noteNote">You can find the HAProxy process id in: <code>/var/run/haproxy.pid</code>. If you encounter any issues starting the service, check if Selinux is enabled; you may want to disable it initially.</p>
                </li>
                <li>
                    <p class="topLevel">

Connect:</p>
                    <p>You can now connect  JDBC&#160;clients, including the Splice Machine command line interpreter,  sqlshell.sh. Use the following JDBC URL:</p>
                    <div class="preWrapperWide"><pre class="Plain">jdbc:splice://&lt;haproxy_host&gt;:1527/splicedb;user=splice;password=admin</pre>
                    </div>
                    <p>For ODBC clients to connect through HAProxy, ensure that the DSN entry in file <code>.odbc.ini</code> is pointing to the HAProxy host.</p>
                </li>
                <li>
                    <p class="topLevel">

Verify that inbound requests are being routed correctly:</p>
                    <p>You can check the logs at <code>/var/log/haproxy.log</code> to make sure that inbound requests are being routed to Splice&#160;Machine region servers that are receiving inbound requests on port 1527.</p>
                </li>
                <li>
                    <p class="topLevel">

View traffic statistics:</p>
                    <p>If you have enabled HAProxy stats, as in our  example, you can view the  overall traffic statistics  in browser at: </p>
                    <div class="preWrapperWide"><pre class="Plain">http://&lt;haproxy_host&gt;:1936/haproxy?stats</pre>
                    </div>
                    <p>You'll see a report that looks similar to this:</p>
                    <p>
                        <img src="images/haproxystats.png" title="HAProxy statistics screenshot" alt="HAProxy statistics" class="indentedTightSpacing" /> </p>
                </li>
            </ol>
        </div>
        <h2 id="Using">Using HAProxy with Splice Machine on a Kerberos-Enabled Cluster</h2>
        <p>Your JDBC applications can authenticate to the backend region server through HAProxy on a Splice Machine cluster that has Kerberos enabled, </p>
        <p>You can enable Kerberos mode on a CDH5.8.x cluster using the configuration wizard described here: </p>
        <div class="preWrapperWide"><pre class="Plain">https://www.cloudera.com/documentation/enterprise/5-8-x/topics/cm_sg_intro_kerb.html.</pre>
        </div>
        <p>As a Kerberos pre-requisite for Splice Machines JDBC access:</p>
        <ul>
            <li>Database users must be added in the Kerberos realm as principals</li>
            <li>Keytab entries must be generated and deployed to the remote clients on which the JDBC applications are going to connect.</li>
        </ul>
        <p>HAProxy will then transparently forward the connections to the back-end cluster in Kerberos setup.</p>
        <h3>Example</h3>
        <p>This example assumes that you are using the default user name <code>splice</code>. Follow these steps to connect through HAProxy:</p>
        <div class="opsStepsList">
            <ol class="boldFont">
                <li>
                    <p class="topLevel">

Create the principal in Kerberos Key Distribution Center</p>
                    <p class="indentLevel1">Create the principal splice@kerberos_realm_name in Kerberos Key Distribution Center (KDC). This generates a keytab file named <code>splice.keytab</code>. </p>
                </li>
                <li>
                    <p class="topLevel">

Copy the generated keytab file</p>
                    <p class="indentLevel1">Copy the <code>splice.keytab</code> file that to all client systems.</p>
                </li>
                <li>
                    <p class="topLevel">Connect:</p>
                    <p>You can now connect  to the Kerberos-enabled Splice Machine cluster through HAProxy, using the following URL:</p>
                    <div class="preWrapperWide"><pre class="Plain">jdbc:splice://&lt;haproxy_host&gt;:1527/splicedb;principal=splice@&lt;realm_name&gt;;keytab=/&lt;path&gt;/splice.keytab</pre>
                    </div>
                </li>
            </ol>
        </div>
        <p>Use the same steps to allow other Splice Machine users to connect by adding them to the Kerberos realm and copying the keytab files to their client systems. This example sets up access for a new user name <code>jdoe</code>. </p>
        <div class="opsStepsList">
            <ol class="boldFont">
                <li>
                    <p class="topLevel">

Create the user in your Splice Machine database:</p>
                    <div class="preWrapperWide"><pre class="Example">call syscs_util.syscs_create_user(&#160;'jdoe', 'jdoe'&#160;);</pre>
                    </div>
                </li>
                <li>
                    <p class="topLevel">Grant privileges to the user</p>
                    <p class="indentLevel1">For this example, we are granting all privileges on a table named <code>myTable</code> to the new user:</p>
                    <div class="preWrapperWide"><pre class="Example">grant all privileges on splice.myTable to jdoe;</pre>
                    </div>
                </li>
                <li>
                    <p class="topLevel">Use KDC&#160;to create a new principal and generate a keytab file. For example:</p>
                    <div class="preWrapperWide"><pre class="Example">#&#160;kadmin.local addprinc -randkey jdoe@SPLICEMACHINE.COLO</pre>
                    </div>
                </li>
                <li>
                    <p class="topLevel">Set the password for the new principal:</p>
                    <div class="preWrapperWide"><pre class="ShellCommand">#&#160;kadmin.local cpw jdoe<br />Enter password for principal "jdoe@SPLICEMACHINE.COLO":</pre>
                    </div>
                </li>
                <li>
                    <p class="topLevel">Create keytab file jdoe.keytab</p>
                    <div class="preWrapperWide"><pre class="ShellCommand">#&#160;kadmin:&#160;xst -k jdoe.keytab jdoe@SPLICEMACHINE.COLO<br /></pre>
                    </div>
                </li>
                <li>
                    <p class="topLevel">Copy the generated keytab file to the client system</p>
                </li>
                <li>
                    <p class="topLevel">Connect through HAProxy with the following URL:</p>
                    <div class="preWrapperWide"><pre class="Plain">jdbc:splice://ha-proxy-host:1527/splicedb;principal=user1@SPLICEMACHINE.COLO;keytab=/home/splice/user1.keytab<br /></pre>
                    </div>
                </li>
            </ol>
        </div>
        </div>
	</section>
